# koa-seneca-cli
Nodejs 微服务实践   

NodeJS在I/O密集型应用中所表现的突出能力使得越来越多的开发者青睐。如今越来越多的应用涉及到的都是I/O方面的业务，故而NodeJS在性能和学习成本方面展现了很大优势。在微服务架构的席卷下，甚至好多大型应用会采用“NodeJS+其他开发语言”这种多语言开发模式进行开发。所以“NodeJS微服务开发”是很有必要的。       

进度：未完成，暂时搁置。

## 问题
1. seneca官方没有完善的案例和文档，且相关的一些插件更新时间都比较古老。
2. 与koa2框架的结合有很多问题，网络上暂未找到完善的案例文档。
3. 在日志打印方面遇到一些问题。seneca内置的log功能并不好用，无法将info和error分开，且日志结构为对象，难于阅读，与log4js等日志插件相去甚远。若与log4js同用，会很乱。
4. 使用seneca-entity构建数据模型出现一些未知问题，与redis结合只能创建hash数据。没有很好的插件支持。若结合mysql等数据库的话也没有完善的API用于crud。
5. 注册中心、配置中心、路由等都需要自己摸索，没有现成的案例。
6. 感觉使用seneca的人较少，也可能是使用nodejs搭建微服务暂无广泛的应用。
7. 找到一款机遇nodejs的响应式微服务框架Moleculer，官方文档较为完善且有近期更新，可进行尝试。

## 主要依赖\技术栈

- TypeScript：使用TS方便函数和参数的类型检测
- Koa2：一种以AOP(面向切面编程)的web开发框架，主要思路为洋葱模型和中间件架构
- Seneca：一种基于“模式”的微服务框架，其原理类似于事件(消息)通知
- PM2：强大的Nodejs应用部署器（先前自己项目使用pkg模块进行打包后再进行部署，在linux下需要使用nohub命令，在win下需要生成nohub.vbs脚本进行执行，而在微服务框架下，打包多个应用后各自运行不便于集中管理，所以还是直接使用pm2）

## 架构

| 名称          | 技术模式/框架 | 说明                                                   |
| ------------- | ------------- | ------------------------------------------------------ |
| 网关/负载均衡 | Nginx         | 对前后端的沟通进行统一的管理                           |
| 配置中心      | configurationCenter服务(内置)  | 所有服务的配置统一管理，各服务会定期pull各自相应的配置参数到缓存中（配置中心初步使用yaml文件进行配置，各服务也暂用yaml文件进行缓存，后期可更改为数据库和redis）  |
| 注册中心      | registerCenter服务(内置)  | 对所有微服务配置进行管理，服务必须注册登记才能使用，主服务接口请求时候进行client,只在第一次请求时client       |
| 微服务        | Seneca        | 创建各种单一职责和接口分离模块(插件)，各微服务可分布式部署到不同服务器 |



## 内置服务/功能

| 功能   | 服务/框架 | 端口 |
| ------ | --------- | ---- |
| 数据库 | Mysql     |      |
| 数据模型/实体 | seneca-entity  |      |
| 缓存库 | Redis(这里使用redis而不用其他库，因为redis便于后期管理)     |      |
| 日志   | log4js/Seneca内置日志，配合PM2插件输出到文件 |      |


## 配置文件
yaml配置文件阅读方便，支持多种类型（字符串、数值、布尔值、null、时间戳、数组），可注释，故而用途广泛，比json和ini等好太多。   
Nodejs读写yaml需要用到yaml库。
```js
import YAML from 'yaml'
// 读取
const file = fs.readFileSync('./config.yaml', 'utf8')
const yamlStr = YAML.parse(file)
console.log(yamlStr)
// 写入
const options = {a:1, b:2}
fs.writeFileSync('config.yaml', YAML.stringify(options))
```

## 启动